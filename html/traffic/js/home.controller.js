"use strict";app.controller("homeController",["$scope","$state","$cookieStore","$filter","HomeService","HelperService","SchedulingService","$localStorage",function(l,e,t,o,a,r,n,i){if(l.USER=t.get("caroa.user"),l.USER){l.showMoney=function(){return 5==l.USER.companyType};var s=l.USER.token;a.updateToken(s).success(function(e){r.getAPICode(e,function(){l.USER=e.data,s=l.USER.token,t.put("caroa.user",e.data)})});var d=l.USER.phone+"_promotion",p=!(l.showPromotion=!1);i.hasOwnProperty(d)&&(p=i[d]),p&&a.showPromotion(s).success(function(e){r.getAPICode(e,function(){0===e.data?l.showPromotion=!0:($(".promotion-div").remove(),l.showPromotion=!1)})});var c=!1;l.checkedPromotion=function(){c=!(i[d]=c)},l.closePromotion=function(){$(".promotion-div").remove()},l.openSales=function(){$(".promotion-div").remove(),e.go("app.sales.list")},l.drawTotals=function(e,t){var o=e.chart.width,a=e.chart.height,r=e.chart.ctx,n=(a/160).toFixed(2);r.font=n+"em sans-serif",r.textBaseline="middle",r.textAlign="center",r.fillStyle="#46b31c";var i="全部车辆";Math.round((o-1.3*r.measureText(i).width)/2);i=l.totalVehicles,r.save()},l.profile={},l.totalVehicles=0,a.profile(s).success(function(o){r.getAPICode(o,function(){l.profile=o.data,l.profile.todayTotal=l.profile.today[1]+l.profile.today[2]+ +l.profile.today[4]+l.profile.today[8]+l.profile.today[16]+l.profile.today[32]+l.profile.today[64],l.profile.tomorrowTotal=l.profile.tomorrow[1]+l.profile.tomorrow[2]+l.profile.tomorrow[4]+l.profile.tomorrow[8]+l.profile.tomorrow[16]+l.profile.tomorrow[32]+l.profile.tomorrow[64],l.totalVehicles=o.data.gps[1]+o.data.gps[2]+o.data.gps[4]+o.data.gps[3]+o.data.gps[0];var e=document.getElementById("carMonitorChart");if(e){var t=e.getContext("2d");new Chart(t,{type:"doughnut",data:{datasets:[{data:[o.data.gps[1],o.data.gps[2],o.data.gps[4],o.data.gps[3],o.data.gps[0]],backgroundColor:["rgb(2,254,255)","rgb(246,240,44)","rgb(103,155,255)","rgb(200, 55, 2)","rgb(255,100,0)"],label:"Dataset 1"}],labels:["未装车辆","行驶车辆","静止车辆","离线车辆","过期车辆"]},options:{responsive:!0,cutoutPercentage:75,legend:{display:!0,position:"right",labels:{fontColor:"#F4F4F4",generateLabels:function(c){var u=c.data;return u.labels.length&&u.datasets.length?u.labels.map(function(e,t){var o=c.getDatasetMeta(0),a=u.datasets[0],r=o.data[t],n=r&&r.custom||{},i=Chart.helpers.getValueAtIndexOrDefault,l=c.options.elements.arc,s=n.backgroundColor?n.backgroundColor:i(a.backgroundColor,t,l.backgroundColor),d=n.borderColor?n.borderColor:i(a.borderColor,t,l.borderColor),p=n.borderWidth?n.borderWidth:i(a.borderWidth,t,l.borderWidth);return{text:e+" : "+c.config.data.datasets[r._datasetIndex].data[r._index],fillStyle:s,strokeStyle:d,lineWidth:p,hidden:isNaN(a.data[t])||o.data[t].hidden,index:t}}):[]}}},animation:{onComplete:function(e){}}}})}})}),l.isBitEqual=function(e){return r.isBitEqual(l.user.moduleRead,e)};var u=o("date")(new Date,"yyyy-MM-dd");n.getHalfYearSchedulingByUser({calDate:u},s).success(function(s){r.getAPICode(s,function(){var e=[],t=[];for(var o in s.data){var a=s.data[o].split("=");if(2==a.length){var r=parseInt(a[0].split("-")[1]);e.push(r+"月"),t.push(a[1])}}var n={labels:e,datasets:[{label:"次数",backgroundColor:"#27f4a1",borderColor:"#27f4a1",data:t}]},i=document.getElementById("halfYearSchedules");if(i){var l=i.getContext("2d");new Chart(l,{type:"bar",data:n,options:{elements:{rectangle:{borderWidth:2}},responsive:!0,legend:{position:"right",display:!1},scales:{yAxes:[{ticks:{beginAtZero:!0,min:0}}]}}})}},function(){alertError(s.msg)})}),a.travelSummary(s,u).success(function(c){r.getAPICode(c,function(){var e=[],t=[],o=[],a=[];for(var r in c.data){var n={key:r,miles:c.data[r].MILES,travelTime:c.data[r].TIME};a.push(n)}a.sort(function(e,t){return e.key>t.key?1:-1});for(var i=0;i<a.length;i++){var l=parseInt(a[i].key.split("-")[1]);e.push(l+"月"),t.push(a[i].miles/1e3);var s=Math.round(a[i].travelTime/3600*100)/100;o.push(s)}var d=document.getElementById("travelSummary");if(d){var p=d.getContext("2d");new Chart(p,{type:"line",data:{labels:e,pointStyle:"line",datasets:[{label:"里程",borderColor:"rgb(255,198,19)",data:t,fill:!1,yAxisID:"y-axis-1",lineTension:0,pointStyle:"line"},{label:"时长",borderColor:"rgb(0, 99, 250)",data:o,fill:!1,yAxisID:"y-axis-2",lineTension:0}]},bezierCurve:!1,options:{bezierCurve:!1,scales:{yAxes:[{type:"linear",display:!0,position:"left",id:"y-axis-1",ticks:{beginAtZero:!0,min:0}},{type:"linear",display:!0,position:"right",id:"y-axis-2",ticks:{beginAtZero:!0,min:0}}]},legend:{pointStyle:"line",display:!1}}})}},function(){alertError(c.msg)})}),a.expenseProfile(s,u).success(function(u){r.getAPICode(u,function(){var e=[],t=[],o=[],a=[],r=[];for(var n in u.data){var i={key:n,in:u.data[n].in,out:u.data[n].out,total:u.data[n].total};r.push(i)}r.sort(function(e,t){return e.key>t.key?-1:1});for(var l=0;l<r.length;l++){var s=parseInt(r[l].key.split("-")[1]);e.push(s+"月"),t.push(r[l].in),o.push(-r[l].out),a.push(r[l].total)}var d={labels:e,datasets:[{label:"收入",backgroundColor:"rgb(38, 247, 206)",borderColor:"rgb(38, 247, 206)",data:t},{label:"支出",backgroundColor:"rgb(1, 168, 250)",borderColor:"rgb(1, 168, 250)",data:o},{label:"利润",backgroundColor:"rgb(255, 142, 100)",borderColor:"rgb(255, 142, 100)",data:a}]},p=document.getElementById("financialChart");if(p){var c=p.getContext("2d");new Chart(c,{type:"horizontalBar",data:d,options:{elements:{rectangle:{borderWidth:2}},responsive:!0,legend:{display:!1}}})}},function(){alertError(u.msg)})})}else e.go("login")}]);